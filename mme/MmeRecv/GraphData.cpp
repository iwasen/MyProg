//*****************************************************************************************************
//  1. ファイル名
//		GraphData.cpp
//----------------------------------------------------------------------------------------------------
//  2. 機能
//		グラフデータクラスの実装
//----------------------------------------------------------------------------------------------------
//  3. 備考
//		無し
//*****************************************************************************************************

#include "StdAfx.h"
#include "GraphData.h"

//*****************************************************************************************************
//  1. 関数名
//		CGraphData::CGraphData
//----------------------------------------------------------------------------------------------------
//  2. 機能
//		コンストラクタ
//----------------------------------------------------------------------------------------------------
//  3. パラメータ説明
//		無し
//----------------------------------------------------------------------------------------------------
//  4. 戻り値
//		無し
//*****************************************************************************************************
CGraphData::CGraphData(void)
{
	m_nBufSize = 0;
	m_nDataNum = 0;
	m_nDataIndex = 0;
}

//*****************************************************************************************************
//  1. 関数名
//		CGraphData::operator=
//----------------------------------------------------------------------------------------------------
//  2. 機能
//		代入オペレータ
//----------------------------------------------------------------------------------------------------
//  3. パラメータ説明
//		CGraphData	&oSrc		[I] 代入元グラフデータ
//----------------------------------------------------------------------------------------------------
//  4. 戻り値
//		CGraphData		代入元グラフデータ
//*****************************************************************************************************
CGraphData &CGraphData::operator=(CGraphData &oSrc)
{
	// 配列データをコピー
	m_nDataNum = oSrc.GetDataNum();
	SetBufSize(m_nDataNum);
	for (int i = 0; i < m_nDataNum; i++)
		m_aGraphData.SetAt(i, oSrc.GetGraphData(i));

	return oSrc;
}

//*****************************************************************************************************
//  1. 関数名
//		CGraphData::SetBufSize
//----------------------------------------------------------------------------------------------------
//  2. 機能
//		バッファサイズを設定する
//----------------------------------------------------------------------------------------------------
//  3. パラメータ説明
//		int	nBufSize		[I] バッファサイズ
//----------------------------------------------------------------------------------------------------
//  4. 戻り値
//		無し
//*****************************************************************************************************
void CGraphData::SetBufSize(int nBufSize)
{
	m_aGraphData.SetSize(nBufSize);
	m_nBufSize = nBufSize;
}

//*****************************************************************************************************
//  1. 関数名
//		CGraphData::Reset
//----------------------------------------------------------------------------------------------------
//  2. 機能
//		バッファをリセットする
//----------------------------------------------------------------------------------------------------
//  3. パラメータ説明
//		無し
//----------------------------------------------------------------------------------------------------
//  4. 戻り値
//		無し
//*****************************************************************************************************
void CGraphData::Reset()
{
	m_nDataNum = 0;
	m_nDataIndex = 0;
}

//*****************************************************************************************************
//  1. 関数名
//		CGraphData::AddGraphData
//----------------------------------------------------------------------------------------------------
//  2. 機能
//		バッファにグラフデータを追加する
//----------------------------------------------------------------------------------------------------
//  3. パラメータ説明
//		CTime		&oTimestamp			[I] タイムスタンプ
//		SStatusWord	&oStatusWord		[I] ステータスワード
//		SAnalogData	&oAnalogData		[I] アナログデータ
//----------------------------------------------------------------------------------------------------
//  4. 戻り値
//		無し
//*****************************************************************************************************
void CGraphData::AddGraphData(const CTime &oTimestamp, const SStatusWord &oStatusWord, const SAnalogData &oAnalogData)
{
	SGraphData oGraphData;

	// グラフデータを生成
	oGraphData.oTimestamp = oTimestamp;
	for (int nUnit = 0; nUnit < N_UNIT; nUnit++) {
		oGraphData.aUnit[nUnit].nRange = oStatusWord.aUnit[nUnit].nRangeStatus - 1;
		oGraphData.aUnit[nUnit].aData[GRAPH_X] = (float)oAnalogData.aUnit[nUnit].fTemp[TEMP_X];
		oGraphData.aUnit[nUnit].aData[GRAPH_Y] = (float)oAnalogData.aUnit[nUnit].fTemp[TEMP_Y];
		oGraphData.aUnit[nUnit].aData[GRAPH_Z] = (float)oAnalogData.aUnit[nUnit].fTemp[TEMP_Z];
		oGraphData.aUnit[nUnit].aData[GRAPH_SB] = (float)oAnalogData.aUnit[nUnit].fTemp[TEMP_SB];
		oGraphData.aUnit[nUnit].aData[GRAPH_HEATER] = (float)oAnalogData.aUnit[nUnit].fHeater;
	}

	if (m_nBufSize == 0) {
		// グラフデータを配列に追加
		m_aGraphData.Add(oGraphData);
		m_nDataNum++;
	} else {
		// グラフデータを配列にセット
		m_aGraphData.SetAt(m_nDataIndex, oGraphData);

		// リングバッファ処理
		if (++m_nDataIndex >= m_nBufSize)
			m_nDataIndex = 0;

		if (m_nDataNum < m_nBufSize)
			m_nDataNum++;
	}
}

//*****************************************************************************************************
//  1. 関数名
//		CGraphData::GetGraphData
//----------------------------------------------------------------------------------------------------
//  2. 機能
//		指定したインデックスのグラフデータを取得する
//----------------------------------------------------------------------------------------------------
//  3. パラメータ説明
//		int		nIndex			[I] インデックス
//----------------------------------------------------------------------------------------------------
//  4. 戻り値
//		無し
//*****************************************************************************************************
SGraphData &CGraphData::GetGraphData(int nIndex)
{
	if (m_nBufSize != 0 && m_nDataNum == m_nBufSize) {
		// リングバッファのインデックスを求める
		nIndex += m_nDataIndex;
		if (nIndex >= m_nBufSize)
			nIndex -= m_nBufSize;
	}

	return m_aGraphData[nIndex];
}

//*****************************************************************************************************
//  1. 関数名
//		CGraphData::GetDataNum
//----------------------------------------------------------------------------------------------------
//  2. 機能
//		グラフデータ数を取得する
//----------------------------------------------------------------------------------------------------
//  3. パラメータ説明
//		無し
//----------------------------------------------------------------------------------------------------
//  4. 戻り値
//		int		データ数
//*****************************************************************************************************
int CGraphData::GetDataNum()
{
	return m_nDataNum;
}